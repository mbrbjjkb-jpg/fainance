<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>投資信託ポートフォリオ計算ツール</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  textarea { width: 100%; height: 80px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  button { margin: 5px; }
  #summary { margin-top: 20px; font-weight: bold; white-space: pre-line; }
</style>
</head>
<body>
<h2>投資信託ポートフォリオ計算ツール</h2>
<textarea id="inputText" placeholder="ここに全銘柄情報を貼り付け"></textarea>
<button onclick="parseAllStocks()">全銘柄解析・計算</button>
<table id="stockTable">
  <thead>
    <tr>
      <th>銘柄名</th>
      <th>購入価格</th>
      <th>保有数</th>
      <th>時価</th>
      <th>損益</th>
      <th>NISA</th>
      <th>投資期間</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<div id="summary" tabindex="0"></div>
<script>
const stocks = [];

function parseNumber(text) {
  return parseFloat(text.replace(/[,+%\s]/g,''));
}

function calculatePeriod(start, end) {
  const startDate = new Date(start);
  const endDate = end ? new Date(end) : new Date();
  let years = endDate.getFullYear() - startDate.getFullYear();
  let months = endDate.getMonth() - startDate.getMonth();
  if(months < 0) { years -=1; months += 12; }
  return `${startDate.getFullYear()}/${('0'+(startDate.getMonth()+1)).slice(-2)}〜${end ? (endDate.getFullYear()+'/'+('0'+(endDate.getMonth()+1)).slice(-2)) : '現在まで'}（${years}年${months}か月）`;
}

function parseAllStocks() {
  stocks.length = 0;
  const inputField = document.getElementById('inputText');
  const text = inputField.value;
  const blocks = text.split(/\n(?=チャート画像)/);

  blocks.forEach(block => {
    const nameMatch = block.match(/投信\s*\n?(.*)/);
    if(!nameMatch) return;
    let name = nameMatch[1].trim();
    const purchaseMatch = block.match(/購入価格\s*\n?([0-9,\.]+)/);
    const unitsMatch = block.match(/保有数\s*\n?([0-9,\.]+)/);
    const marketMatch = block.match(/時価\s*\n?([0-9,\.]+)/);
    const profitMatch = block.match(/損益\s*\n?([\+\-0-9,\.]+)/);
    if(!purchaseMatch || !unitsMatch || !marketMatch || !profitMatch) return;

    const purchasePrice = parseNumber(purchaseMatch[1]);
    const units = parseNumber(unitsMatch[1]);
    const marketValue = parseNumber(marketMatch[1]);
    const profit = parseNumber(profitMatch[1]);

    let isNISA = false;
    let periodStart = null;
    let periodEnd = null;

    if(name.includes('楽天・全米株式インデックス･ファンド') && units === 23.5) {
      name = '楽天・全米株式インデックス･ファンド（新NISA）';
      isNISA = true;
      periodStart = '2024-01-01';
    }
    if(name.includes('楽天・全米株式インデックス･ファンド') && units === 53.2) {
      name = '楽天・全米株式インデックス･ファンド（旧NISA）';
      isNISA = true;
      periodStart = '2021-05-01';
      periodEnd = '2023-12-31';
    }
    if(name.includes('セゾン･グローバルバランスファンド')) {
      periodStart = '2017-05-01';
    }
    if(name.includes('ひふみ投信')) {
      periodStart = '2016-06-01';
    }
    if(name.includes('iシェアーズ 米国株式')) {
      periodStart = '2017-05-01';
      periodEnd = '2021-04-30';
    }

    const profitPercent = ((profit / (purchasePrice * units)) * 100).toFixed(2);
    const period = periodStart ? calculatePeriod(periodStart, periodEnd) : '不明';

    stocks.push({name, purchasePrice, units, marketValue, profit, profitPercent, isNISA, period});
  });

  // 入力フォームをクリア
  document.getElementById('inputText').value = '';

  renderTable();
  calculateTotal();
  document.getElementById('summary').focus();
}

function renderTable() {
  const tbody = document.querySelector('#stockTable tbody');
  tbody.innerHTML = '';
  for(const s of stocks) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td>${s.purchasePrice.toLocaleString()}円</td><td>${s.units}</td><td>${s.marketValue.toLocaleString()}円</td><td>${s.profit.toLocaleString()}円 (+${s.profitPercent}%)</td><td>${s.isNISA ? 'NISA':'課税'}</td><td>${s.period}</td>`;
    tbody.appendChild(tr);
  }
}

function calculateTotal() {
  let totalMarket = 0;
  let totalPurchase = 0;
  let totalProfit = 0;
  let taxableProfit = 0;
  let nisaProfit = 0;
  const TAX_RATE = 0.2;

  for(const s of stocks) {
    totalMarket += s.marketValue;
    totalPurchase += s.purchasePrice * s.units;
    totalProfit += s.profit;
    if(s.isNISA) nisaProfit += s.profit;
    else taxableProfit += s.profit;
  }

  const tax = Math.round(taxableProfit * TAX_RATE);
  const afterTaxProfit = Math.round(totalProfit - tax);
  const afterTaxMarket = Math.round(totalMarket - tax);
  const totalProfitPercent = ((totalProfit / totalPurchase) * 100).toFixed(2);

  const summaryDiv = document.getElementById('summary');
  summaryDiv.innerText =
    `合計時価: ${Math.round(totalMarket).toLocaleString()}円（ 総損益: ${Math.round(totalProfit).toLocaleString()}円 (+${totalProfitPercent}%) ＋購入価格: ${Math.round(totalPurchase).toLocaleString()}円）\n\n` +
    `課税対象利益: ${Math.round(taxableProfit).toLocaleString()}円\n` +
    `(想定税額20%: ${tax.toLocaleString()}円）\n` +
    `※NISA利益(非課税): ${Math.round(nisaProfit).toLocaleString()}円\n` +
    `税引き利益: ${afterTaxProfit.toLocaleString()}円\n\n` +
    `税引き後合計時価: ${afterTaxMarket.toLocaleString()}円`;
}
</script>
</body>
</html>